<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>Bootstrap 101 Template</title>

<!-- Bootstrap -->
<link href="static/css/bootstrap.min.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="static/themes/default/style.min.css" /> 
<style>
body {
    margin: 1em;
}
</style>
</head>
<body role="document">

<div class="container">
    <div class="jumbotron">
        <h1>CTP demo</h1>
        <p>
        This URL provides access to a lightweight CTP client for testing purposes only.
        Launch the client by entering your access token and clicking on the button below.
        </p>
        <form id="bootctp">
            <div class="form-group">
                <label for="text">Token</label>
                <input type="password" id="token" name="token" placeholder="security token" class="form-control">
            </div>
            <button class="btn btn-primary btn-lg" type="Submit" role="button">Start client</button>
        </form>
        <p id="errormsg" class="text-danger"></p>
        <p id="ctp">
            <span class='label label-default'>ctp server</span> 
            <button type="button" class="btn btn-default" data-toggle="tooltip" data-placement="right" title="click to refresh the ctp data" id="refreshctp"><i class="glyphicon glyphicon-refresh"></i></button>
            <div id="jstree"></div>
        </p>
    </div>
    <h1>About this demo</h1>
    <p>
    This lightweight client is provided at this URL for demonstration or testing purposes. 
    It has not been tested for security and cross-browser compatibility.
    Users of CTP will likely develop their own client, using the CTP API. 
    </p>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/jstree.min.js"></script>
<script>


function getTypeAndId(url) {
    var match = /\/api\/1\.0\/([^\?]*)/g.exec(url)
    if (match != null) {
        return match[1].split("/")
    }
    return []
}

folder_keys = [ "metrics", "dependencies", "serviceViews", "assets", "attributes", "measurements", "triggers", "logs" ]
ignore_keys = [ "serviceView", "asset", "attribute" ]

function mapObject(obj) {
    var children = []
        if (typeof(obj) !== 'object') {
        return false
    }

    for (var key in obj) {
        if (obj.hasOwnProperty(key)) {
            var grand_children = mapObject(obj[key])
                if (grand_children !== false) {
                    children.push({ text: "<b>" + key + ":</b>", 
                            icon: "glyphicon glyphicon-minus",
                            state: { opened: true },
                            children: grand_children
                            })
                } else {
                    children.push({ text: "<b>" + key + ":</b> <code>" + obj[key] + "</code>", 
                            icon: "glyphicon glyphicon-minus",
                            }) 
                }
        }
    }
    return children
}

function parser(data, cb) {
    var nodes = []

    if (data.hasOwnProperty("collection")) {
        // case 1: this is collection of resources
        var collectionLength = data.collection.length
        for (var i = 0; i<collectionLength; i++)
        {
            var parts = getTypeAndId(data.collection[i].link)
            var text = parts[1]
            if (typeof data.collection[i].name != "undefined")
                text = '"' + data.collection[i].name + '"'
            nodes.push({ text: "<b>" + text + "</b>", 
                         icon: "glyphicon glyphicon-stop",
                         id: data.collection[i].link, 
                         children: true })
        }
    } else { 
        // case 2: this is a simple resource
        for (var key in data) {
            if (ignore_keys.indexOf(key)>=0) {
                continue
            }
            if (data.hasOwnProperty(key)) {
                if (folder_keys.indexOf(key)>=0) {
                    nodes.push({ text: "<span class='label label-success'>" + key + "</span>", 
                                 icon: "glyphicon glyphicon-th-list",
                                 id: data[key], 
                                 children:  true })
                } else {
                    var children = mapObject(data[key])
                    if (children !== false) {
                        nodes.push({ text: "<span class='label label-default'>" + key + ":</span>", 
                                     icon: "glyphicon glyphicon-info-sign",
                                     state: { opened: true },
                                     children: children
                                 })
                    } else {
                        nodes.push({ text: "<span class='label label-default'>" + key + ":</span> <code>" + data[key] + "</code>", 
                                     icon: "glyphicon glyphicon-info-sign",
                                 }) 
                    }
                }
            }
        }
    }
    cb.call(this, nodes)
}

function restorePageAfterError(resp) {
    $("#ctp").hide()
    $("#bootctp").show()
    var err = $.parseJSON(resp.responseText);
    if (err=="") {
        err={ "error": "Unknown error" };
    }
    $('#jstree').jstree("destroy").empty()
    $("#errormsg").show()
    $("#errormsg").text('Error loading data:'+ err.error)
    $("#errormsg").delay(5000).fadeOut(500)
}

$(function () {
        // 
        $("#ctp").hide()
        $('[data-toggle="tooltip"]').tooltip()

        // launch jstree on click
        $("#bootctp").submit(function (event) {
            token = $("#token").val()
            event.preventDefault()
            $("#bootctp").hide()
            $("#ctp").show()
            $('#jstree').jstree({
                'core' : {
                  'data' : function (obj, cb) {
                        if (obj.id === '#') {
                            url = '/api/1.0/'
                            $.ajax({
                                "url": url, 
                                "headers": { "Authorization": "Bearer " + token },
                                "success": function(data) { parser(data,cb) },
                                "error": function(resp) { restorePageAfterError(resp) }
                                })
                        } else {
                            url = obj.id
                            $.ajax({
                                "url": url, 
                                "headers": { "Authorization": "Bearer " + token },
                                "success": function(data) { parser(data,cb) },
                                "error": function(resp) { restorePageAfterError(resp) }
                                })
                        }
                     }
                  }
                }); 
             });
        $("#refreshctp").click(function () {
            $("#jstree").jstree(true).refresh()
            });
        });
</script>
</body>
</html>
